<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ë–∞—à–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞</title>
    <link rel="stylesheet" href="../arkanoid/style.css">
    <style>
        html, body {
            height: 100%;
            margin: 0;
            padding: 0;
        }
        body {
            min-height: 100vh;
            min-width: 100vw;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #18181b 0%, #6366f1 100%);
            display: flex;
            justify-content: center;
            align-items: center;
            overflow: hidden;
        }
        .tower-menu {
            background: rgba(30, 41, 59, 0.95);
            border-radius: 32px;
            box-shadow: 0 8px 40px #0008;
            padding: 48px 32px 40px 32px;
            min-width: 340px;
            display: flex;
            flex-direction: column;
            align-items: center;
            position: relative;
            max-width: 90vw;
            max-height: 90vh;
        }
        .tower-title {
            font-size: 2.5rem;
            font-weight: bold;
            color: #06b6d4;
            margin-bottom: 32px;
            text-shadow: 0 2px 16px #0006;
        }
        .play-button {
            background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%);
            color: #fff;
            font-size: 1.5rem;
            font-weight: 600;
            padding: 16px 48px;
            border: none;
            border-radius: 999px;
            cursor: pointer;
            box-shadow: 0 2px 16px #6366f155;
            transition: transform 0.2s, box-shadow 0.2s;
        }
        .play-button:hover {
            transform: scale(1.07);
            box-shadow: 0 4px 32px #8b5cf655;
        }
        .tower-icon {
            width: 80px;
            height: 80px;
            margin-bottom: 24px;
            background: linear-gradient(135deg, #6366f1 60%, #06b6d4 100%);
            border-radius: 24px 24px 12px 12px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            position: relative;
            box-shadow: 0 4px 24px #06b6d455;
        }
        .tower-icon::after {
            content: '';
            display: block;
            width: 32px;
            height: 16px;
            background: #fff;
            border-radius: 0 0 16px 16px;
            position: absolute;
            left: 50%;
            bottom: -8px;
            transform: translateX(-50%);
            opacity: 0.7;
        }
        .arrow {
            position: absolute;
            left: 50%;
            top: 18px;
            transform: translateX(-50%) rotate(-10deg);
            width: 44px;
            height: 8px;
            background: linear-gradient(90deg, #fbbf24 60%, #fff 100%);
            border-radius: 4px;
            box-shadow: 0 2px 8px #fbbf2444;
        }
        .arrow-head {
            position: absolute;
            right: -8px;
            top: -4px;
            width: 12px;
            height: 16px;
            background: #fff;
            clip-path: polygon(0 0, 100% 50%, 0 100%);
        }
        /* --- Game Window --- */
        #game-window {
            position: fixed;
            left: 0; top: 0; right: 0; bottom: 0;
            width: 100vw; height: 100vh;
            background: linear-gradient(135deg, #18181b 0%, #6366f1 100%);
            z-index: 100;
            display: none;
            justify-content: center;
            align-items: center;
        }
        .game-canvas {
            width: 100vw;
            height: 100vh;
            display: block;
            background: transparent;
        }
        /* –ü–ª—é—Å–∏–∫–∏ */
        .build-spot {
            position: absolute;
            width: 56px;
            height: 56px;
            border: 2px dashed #fff;
            border-radius: 12px;
            background: rgba(255,255,255,0.07);
            display: flex;
            justify-content: center;
            align-items: center;
            cursor: pointer;
            z-index: 2;
            transition: box-shadow 0.2s;
        }
        .build-spot:hover {
            box-shadow: 0 0 16px #06b6d4aa;
        }
        .plus {
            font-size: 2.2rem;
            color: #fff;
            user-select: none;
        }
        /* –ú–µ–Ω—é –≤—ã–±–æ—Ä–∞ –±–∞—à–Ω–∏ */
        .tower-menu-popup {
            position: absolute;
            left: 50%;
            top: -90px;
            transform: translateX(-50%);
            background: #23263a;
            border-radius: 16px;
            box-shadow: 0 4px 24px #0008;
            padding: 12px 18px;
            min-width: 180px;
            z-index: 10;
            display: flex;
            flex-direction: column;
            gap: 10px;
            animation: popupAppear 0.2s;
        }
        @keyframes popupAppear {
            from { opacity: 0; transform: translateX(-50%) scale(0.8); }
            to { opacity: 1; transform: translateX(-50%) scale(1); }
        }
        .tower-choice {
            display: flex;
            align-items: center;
            gap: 10px;
            background: #2d314d;
            border-radius: 10px;
            padding: 8px 10px;
            cursor: pointer;
            transition: background 0.15s;
        }
        .tower-choice:hover {
            background: #3b4070;
        }
        .tower-icon-choice {
            width: 32px; height: 32px;
            display: flex; align-items: center; justify-content: center;
            font-size: 1.5rem;
        }
        .tower-label {
            color: #fff;
            font-size: 1.1rem;
            font-weight: 500;
        }
        .tower-cost {
            color: #fbbf24;
            font-size: 1rem;
            font-weight: 600;
            margin-left: auto;
        }
    </style>
</head>
<body>
    <div class="tower-menu" id="main-menu">
        <button id="menuMusicBtn" style="position:absolute;top:18px;right:18px;font-size:1.7rem;background:none;border:none;cursor:pointer;z-index:10;">üéµ</button>
        <div class="tower-icon">
            <div class="arrow">
                <div class="arrow-head"></div>
            </div>
        </div>
        <div class="tower-title">–ë–∞—à–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞</div>
        <button class="play-button" id="play-btn">–ò–≥—Ä–∞—Ç—å</button>
    </div>
    <div id="coins-ui" style="position:fixed;left:32px;top:24px;z-index:200;display:none;align-items:center;font-size:1.6rem;font-weight:600;color:#fbbf24;text-shadow:0 2px 8px #000a;user-select:none;">
        <span style="display:inline-flex;align-items:center;justify-content:center;width:2.2rem;height:2.2rem;margin-right:8px;">
            <svg width="2rem" height="2rem" viewBox="0 0 40 40" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="20" cy="20" r="18" fill="#fbbf24" stroke="#fff" stroke-width="3"/>
                <ellipse cx="20" cy="20" rx="10" ry="10" fill="#fde68a"/>
                <text x="20" y="26" text-anchor="middle" font-size="16" font-family="Arial" fill="#b45309" font-weight="bold">‚Çø</text>
            </svg>
        </span>
        <span id="coins-count">50</span>
    </div>
    <div id="game-window">
        <canvas id="game-canvas" class="game-canvas"></canvas>
        <!-- build spots and popups will be rendered by JS -->
    </div>
    <!-- –ö–Ω–æ–ø–∫–∞ –≤–æ–ª–Ω—ã –∏ –æ–∫–Ω–æ –ø–æ—Ä–∞–∂–µ–Ω–∏—è -->
    <div id="wave-ui" style="position:fixed;bottom:32px;left:50%;transform:translateX(-50%);z-index:210;display:none;align-items:center;gap:16px;">
        <button id="wave-btn" style="background:#dc2626;color:#fff;font-size:1.4rem;font-weight:700;padding:16px 40px;border:none;border-radius:16px;box-shadow:0 2px 16px #dc262655;cursor:pointer;">–í–æ–ª–Ω–∞</button>
        <span id="wave-num" style="font-size:1.3rem;font-weight:600;color:#fff;text-shadow:0 2px 8px #000a;">1</span>
    </div>
    <div id="defeat-actions" style="display:none;position:fixed;bottom:32px;left:50%;transform:translateX(-50%);z-index:220;gap:24px;display:flex;"></div>
    <script src="../arkanoid/audio.js"></script>
    <script>
    // --- –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –æ–∫–æ–Ω ---
    const playBtn = document.getElementById('play-btn');
    const mainMenu = document.getElementById('main-menu');
    const gameWindow = document.getElementById('game-window');
    const canvas = document.getElementById('game-canvas');
    const ctx = canvas.getContext('2d');
    // --- –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã–µ –∏ –∫–æ–Ω—Å—Ç–∞–Ω—Ç—ã ---
    let coins = 50;
    let towers = [];
    let enemies = [];
    let wave = 1;
    let waveInProgress = false;
    let gameOver = false;
    const TOWER_COSTS = { archer: 25, mage: 50, gatling: 50 };
    const TOWER_RADIUS = { archer: 180, mage: 160, gatling: 140 };
    const TOWER_DAMAGE = { archer: 2, mage: 1, gatling: 1 };
    const TOWER_CHAIN = { archer: 1, mage: 3, gatling: 1 };
    // –î–æ–±–∞–≤–ª—è–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—É–ª–µ–º—ë—Ç–∞
    const GATLING_MAG_SIZE = 6;
    const GATLING_FIRE_DELAY = 6; // 0.1 —Å–µ–∫ –ø—Ä–∏ 60 FPS
    const GATLING_RELOAD_TIME = 120; // 2 —Å–µ–∫ –ø—Ä–∏ 60 FPS
    // --- pathPoints –∏ buildSpots ---
    let pathPoints = [];
    let buildSpots = [];
    function getPointOnPath(t) {
        let total = 0;
        let segLens = [];
        for (let i = 1; i < pathPoints.length; i++) {
            let dx = pathPoints[i].x - pathPoints[i-1].x;
            let dy = pathPoints[i].y - pathPoints[i-1].y;
            let len = Math.sqrt(dx*dx + dy*dy);
            segLens.push(len);
            total += len;
        }
        let dist = t * total;
        let acc = 0;
        for (let i = 1; i < pathPoints.length; i++) {
            if (acc + segLens[i-1] >= dist) {
                let ratio = (dist - acc) / segLens[i-1];
                return {
                    x: pathPoints[i-1].x + (pathPoints[i].x - pathPoints[i-1].x) * ratio,
                    y: pathPoints[i-1].y + (pathPoints[i].y - pathPoints[i-1].y) * ratio
                };
            }
            acc += segLens[i-1];
        }
        return pathPoints[pathPoints.length-1];
    }
    function updatePathAndSpots() {
        pathPoints = [
            {x: 120, y: canvas.height-120},
            {x: 220, y: canvas.height-220},
            {x: canvas.width/2-60, y: canvas.height/2+80},
            {x: canvas.width/2+60, y: canvas.height/2-80},
            {x: canvas.width-220, y: 220},
            {x: canvas.width-120, y: 120}
        ];
        buildSpots = Array.from({length: 5}, (_, i) => getPointOnPath((i+1)/(5+1)));
    }
    function resizeCanvas() {
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        updatePathAndSpots();
        drawGameScene();
        renderBuildSpots();
    }
    window.addEventListener('resize', resizeCanvas);
    resizeCanvas();
    // --- –†–∏—Å—É–µ–º —Å—Ü–µ–Ω—É ---
    function drawGameScene() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        // –¢—Ä–æ–ø–∏–Ω–∫–∞
        ctx.save();
        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 48;
        ctx.lineCap = 'round';
        ctx.setLineDash([32, 24]);
        ctx.beginPath();
        ctx.moveTo(pathPoints[0].x, pathPoints[0].y);
        for(let i=1;i<pathPoints.length;i++) ctx.lineTo(pathPoints[i].x, pathPoints[i].y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.lineWidth = 12;
        ctx.strokeStyle = '#fff8';
        ctx.beginPath();
        ctx.moveTo(pathPoints[0].x, pathPoints[0].y);
        for(let i=1;i<pathPoints.length;i++) ctx.lineTo(pathPoints[i].x, pathPoints[i].y);
        ctx.stroke();
        ctx.restore();
        // –ü–µ—â–µ—Ä–∞-—á–µ—Ä–µ–ø
        drawCave(pathPoints[0].x, pathPoints[0].y);
        // –ó–∞–º–æ–∫
        drawCastle(pathPoints[pathPoints.length-1].x, pathPoints[pathPoints.length-1].y);
        // –ë–∞—à–Ω–∏
        towers.forEach(drawTower);
    }
    function drawCave(x, y) {
        ctx.save();
        ctx.translate(x, y);
        ctx.beginPath();
        ctx.arc(0, 0, 48, Math.PI*0.2, Math.PI*1.8, false);
        ctx.lineTo(-40, 40);
        ctx.lineTo(40, 40);
        ctx.closePath();
        ctx.fillStyle = '#222';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.fill(); ctx.stroke();
        // –ì–ª–∞–∑–∞
        ctx.beginPath(); ctx.arc(-18, -10, 7, 0, 2*Math.PI); ctx.arc(18, -10, 7, 0, 2*Math.PI);
        ctx.fillStyle = '#fff'; ctx.fill();
        ctx.beginPath(); ctx.arc(-18, -10, 3, 0, 2*Math.PI); ctx.arc(18, -10, 3, 0, 2*Math.PI);
        ctx.fillStyle = '#18181b'; ctx.fill();
        ctx.restore();
    }
    function drawCastle(x, y) {
        ctx.save();
        ctx.translate(x, y);
        ctx.fillStyle = '#6366f1';
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.beginPath(); ctx.moveTo(-32, 32); ctx.lineTo(-32, -32); ctx.lineTo(32, -32); ctx.lineTo(32, 32); ctx.closePath(); ctx.fill(); ctx.stroke();
        // –ë–∞—à–µ–Ω–∫–∏
        for(let i=-24;i<=24;i+=24){ ctx.beginPath(); ctx.rect(i-6,-44,12,12); ctx.fillStyle='#8b5cf6'; ctx.fill(); ctx.stroke(); }
        // –î–≤–µ—Ä—å
        ctx.beginPath(); ctx.arc(0, 24, 10, 0, Math.PI, true); ctx.fillStyle='#fff'; ctx.fill(); ctx.stroke();
        ctx.restore();
    }
    // --- build spots ---
    function renderBuildSpots() {
        // –£–¥–∞–ª—è–µ–º —Å—Ç–∞—Ä—ã–µ
        document.querySelectorAll('.build-spot, .tower-menu-popup').forEach(e=>e.remove());
        buildSpots.forEach((spot, i) => {
            if (towers.find(t => t.idx === i)) return; // –µ—Å–ª–∏ —É–∂–µ –ø–æ—Å—Ç—Ä–æ–µ–Ω–∞ –±–∞—à–Ω—è
            const div = document.createElement('div');
            div.className = 'build-spot';
            div.style.left = (spot.x-28)+'px';
            div.style.top = (spot.y-28)+'px';
            div.innerHTML = '<span class="plus">+</span>';
            div.onclick = (e) => {
                e.stopPropagation();
                showTowerMenu(div, spot, i);
            };
            gameWindow.appendChild(div);
        });
    }
    function showTowerMenu(parent, spot, idx) {
        document.querySelectorAll('.tower-menu-popup').forEach(e=>e.remove());
        const menu = document.createElement('div');
        menu.className = 'tower-menu-popup';
        menu.innerHTML = `
            <div class="tower-choice" data-type="archer">
                <div class="tower-icon-choice">üèπ</div>
                <div class="tower-label">–ë–∞—à–Ω—è –ª—É—á–Ω–∏–∫–∞</div>
                <div class="tower-cost">25ü™ô</div>
            </div>
            <div class="tower-choice" data-type="mage">
                <div class="tower-icon-choice">üîÆ</div>
                <div class="tower-label">–ë–∞—à–Ω—è –º–∞–≥–∞</div>
                <div class="tower-cost">50ü™ô</div>
            </div>
            <div class="tower-choice" data-type="gatling">
                <div class="tower-icon-choice">üî´</div>
                <div class="tower-label">–ü—É–ª–µ–º—ë—Ç</div>
                <div class="tower-cost">50ü™ô</div>
            </div>
        `;
        menu.onclick = e => e.stopPropagation();
        menu.querySelectorAll('.tower-choice').forEach(choice => {
            choice.onclick = (e) => {
                e.stopPropagation();
                const type = choice.getAttribute('data-type');
                const cost = TOWER_COSTS[type];
                if (coins < cost) {
                    choice.style.background = '#a00';
                    setTimeout(()=>choice.style.background='', 400);
                    return;
                }
                setCoins(coins - cost);
                towers.push({type, x: spot.x, y: spot.y, idx, cooldown: 0});
                document.querySelectorAll('.tower-menu-popup').forEach(e=>e.remove());
                renderBuildSpots();
            };
        });
        parent.appendChild(menu);
        // –ó–∞–∫—Ä—ã—Ç–∏–µ –ø–æ –∫–ª–∏–∫—É –≤–Ω–µ –º–µ–Ω—é
        setTimeout(()=>{
            window.addEventListener('click', closeMenu, {once:true});
       });
        function closeMenu(){
            menu.remove();
        }
    }
    // --- –†–∏—Å—É–µ–º –±–∞—à–Ω—é ---
    const archerTowerImg = new Image();
    archerTowerImg.src = 'spryts/arrow_tower.png';
    const mageTowerImg = new Image();
    mageTowerImg.src = 'spryts/magic_tower.png';
    const gatlingTowerImg = new Image();
    gatlingTowerImg.src = 'spryts/minygun_tower.png';
    const simpleEnemyImg = new Image();
    simpleEnemyImg.src = 'spryts/simple_enemy.png';
    function drawTower(tower) {
        ctx.save();
        ctx.translate(tower.x, tower.y);
        if (tower.type==='archer') {
            if (archerTowerImg.complete) {
                ctx.drawImage(archerTowerImg, -24, -32, 48, 48);
            }
        } else if (tower.type==='gatling') {
            if (gatlingTowerImg.complete) {
                ctx.drawImage(gatlingTowerImg, -24, -32, 48, 48);
            }
            // –°–∏–Ω—è—è —à–∫–∞–ª–∞ –±–æ–µ–∑–∞–ø–∞—Å–∞
            let ammo = tower.gatlingAmmo ?? GATLING_MAG_SIZE;
            let reload = tower.gatlingReload ?? 0;
            let barH = 44, barW = 8;
            ctx.save();
            ctx.translate(28, -barH/2);
            ctx.beginPath();
            ctx.rect(0, 0, barW, barH);
            ctx.fillStyle = '#334155';
            ctx.fill();
            if (reload > 0) {
                // –ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ ‚Äî –∞–Ω–∏–º–∏—Ä—É–µ–º –∑–∞–ø–æ–ª–Ω–µ–Ω–∏–µ
                let frac = 1 - reload / GATLING_RELOAD_TIME;
                ctx.fillStyle = '#38bdf8';
                ctx.fillRect(0, barH*(1-frac), barW, barH*frac);
            } else {
                ctx.fillStyle = '#38bdf8';
                ctx.fillRect(0, barH*(1-ammo/GATLING_MAG_SIZE), barW, barH*(ammo/GATLING_MAG_SIZE));
            }
            ctx.restore();
        } else if (tower.type==='mage') {
            if (mageTowerImg.complete) {
                ctx.drawImage(mageTowerImg, -24, -32, 48, 48);
            }
        } else {
            // –ë–∞—à–Ω—è –º–∞–≥–∞
            ctx.beginPath();
            ctx.arc(0, 0, 22, 0, 2*Math.PI);
            ctx.fillStyle = '#818cf8';
            ctx.shadowColor = '#a5b4fc';
            ctx.shadowBlur = 12;
            ctx.fill();
            ctx.shadowBlur = 0;
            ctx.beginPath(); ctx.arc(0,-16,10,0,2*Math.PI); ctx.fillStyle='#fbbf24'; ctx.fill();
            ctx.font = '20px Arial'; ctx.fillStyle = '#222'; ctx.fillText('üîÆ', -12, 10);
        }
        ctx.restore();
    }
    // --- –í—Ä–∞–≥–∏ –∏ –≤–æ–ª–Ω—ã ---
    function spawnWave(n) {
        let left = n;
        waveInProgress = true;
        function spawnPack() {
            if (!waveInProgress) return;
            let pack = Math.min(left, Math.floor(Math.random()*3)+1);
            for (let i=0;i<pack;i++) {
                let rand = Math.random();
                if (rand < 0.15) {
                    // 15% —à–∞–Ω—Å –Ω–∞ –±–æ–ª—å—à–æ–≥–æ —Å–µ—Ä–æ–≥–æ –≤—Ä–∞–≥–∞
                    enemies.push({
                        x: pathPoints[0].x,
                        y: pathPoints[0].y,
                        t: 0.0,
                        speed: 0.0006 + Math.random()*0.0003, // –º–µ–¥–ª–µ–Ω–Ω–µ–µ –æ–±—ã—á–Ω–æ–≥–æ
                        hp: 3,
                        alive: true,
                        type: 'tank'
                    });
                } else if (rand < 0.30) {
                    // 15% —à–∞–Ω—Å –Ω–∞ –±—ã—Å—Ç—Ä–æ–≥–æ –≤—Ä–∞–≥–∞
                    enemies.push({
                        x: pathPoints[0].x,
                        y: pathPoints[0].y,
                        t: 0.0,
                        speed: 0.0017 + Math.random()*0.0005, // –±—ã—Å—Ç—Ä–µ–µ –æ–±—ã—á–Ω–æ–≥–æ
                        hp: 1,
                        alive: true,
                        type: 'fast'
                    });
                } else {
                    // –æ–±—ã—á–Ω—ã–π –≤—Ä–∞–≥
                    enemies.push({
                        x: pathPoints[0].x,
                        y: pathPoints[0].y,
                        t: 0.0,
                        speed: 0.001 + Math.random()*0.0005,
                        hp: 1,
                        alive: true,
                        type: 'normal'
                    });
                }
            }
            console.log('–í—Ä–∞–≥–∏ –¥–æ–±–∞–≤–ª–µ–Ω—ã, –≤—Å–µ–≥–æ:', enemies.length);
            left -= pack;
            if (left > 0) setTimeout(spawnPack, 500+Math.random()*400);
        }
        spawnPack();
    }
    function resetGame() {
        setCoins(50);
        towers = [];
        enemies = [];
        wave = 1;
        waveInProgress = false;
        gameOver = false;
        window.waveEnemyCount = undefined;
        document.getElementById('wave-num').textContent = wave;
        document.getElementById('wave-ui').style.display = 'flex';
        document.getElementById('defeat-actions').style.display = 'none';
        resizeCanvas();
        setTimeout(()=>{
            document.getElementById('wave-ui').style.display = 'flex';
            document.getElementById('defeat-actions').style.display = 'none';
        }, 100);
    }
    // --- –ê–Ω–∏–º–∞—Ü–∏—è –∏ —Å—Ç—Ä–µ–ª—å–±–∞ ---
    function gameLoop() {
        drawGameScene();
        // –î–ª—è –æ—Ç–ª–∞–¥–∫–∏
        //console.log('–í—Ä–∞–≥–æ–≤ –Ω–∞ –ø–æ–ª–µ:', enemies.length);
        // –í—Ä–∞–≥–∏
        // –ï—Å–ª–∏ –Ω–µ—Ç –≤—Ä–∞–≥–æ–≤ ‚Äî endGame –Ω–µ –≤—ã–∑—ã–≤–∞–µ–º
        if (enemies.length > 0) {
            enemies.forEach(enemy => {
                if (!enemy.alive) return;
                enemy.t += enemy.speed;
                if (enemy.alive && enemy.t > 1 && !gameOver) {
                    enemy.t = 1;
                    enemy.alive = false;
                    // –ü—Ä–æ–∏–≥—Ä—ã—à
                    endGame();
                }
                const pos = getPointOnPath(enemy.t);
                enemy.x = pos.x;
                enemy.y = pos.y;
            });
        }
        // –†–∏—Å—É–µ–º –≤—Ä–∞–≥–æ–≤ (–∑–µ–ª—ë–Ω—ã–µ —Ç–æ—á–∫–∏)
        enemies.forEach(enemy => {
            if (!enemy.alive) return;
            ctx.save();
            ctx.translate(enemy.x, enemy.y);
            let radius = 13;
            if (enemy.type === 'tank') radius = 20;
            if (enemy.type === 'normal' && simpleEnemyImg.complete) {
                ctx.drawImage(simpleEnemyImg, -radius, -radius, radius*2, radius*2);
            } else {
                ctx.beginPath();
                ctx.arc(0, 0, radius, 0, 2*Math.PI);
                if (enemy.type === 'fast') {
                    ctx.fillStyle = '#166534'; // –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã–π –∑–µ–ª—ë–Ω—ã–π
                    ctx.shadowColor = '#166534';
                } else if (enemy.type === 'tank') {
                    ctx.fillStyle = '#6b7280'; // —Å–µ—Ä—ã–π
                    ctx.shadowColor = '#374151';
                } else {
                    ctx.fillStyle = '#22c55e';
                    ctx.shadowColor = '#16a34a';
                }
                ctx.shadowBlur = 12;
                ctx.fill();
                ctx.shadowBlur = 0;
            }
            ctx.restore();
        });
        // –°—Ç—Ä–µ–ª—å–±–∞ –±–∞—à–µ–Ω
        towers.forEach(tower => {
            tower.cooldown = (tower.cooldown||0) - 1;
            // –ü—É–ª–µ–º—ë—Ç: –æ—Ç–¥–µ–ª—å–Ω–∞—è –ª–æ–≥–∏–∫–∞
            if (tower.type === 'gatling') {
                if (tower.gatlingAmmo === undefined) tower.gatlingAmmo = GATLING_MAG_SIZE;
                if (tower.gatlingReload === undefined) tower.gatlingReload = 0;
                if (tower.gatlingFireDelay === undefined) tower.gatlingFireDelay = 0;
                if (tower.gatlingBullets === undefined) tower.gatlingBullets = [];
                if (tower.gatlingReload > 0) {
                    tower.gatlingReload--;
                    if (tower.gatlingReload === 0) {
                        tower.gatlingAmmo = GATLING_MAG_SIZE;
                    }
                } else if (tower.gatlingAmmo > 0 && tower.gatlingFireDelay <= 0 && !gameOver) {
                    // –ù–∞–π—Ç–∏ –≤—Ä–∞–≥–∞
                    let inRange = enemies.filter(e => e.alive && Math.hypot(e.x-tower.x, e.y-tower.y) < TOWER_RADIUS.gatling && e.hp > 0);
                    if (inRange.length) {
                        // –°—Ç—Ä–µ–ª—è–µ–º –ø—É–ª–µ–π
                        let target = inRange[0];
                        tower.gatlingBullets.push({
                            x: tower.x,
                            y: tower.y-10,
                            target: target,
                            progress: 0
                        });
                        target.hp -= 1;
                        if (target.hp <= 0) {
                            target.alive = false;
                            setCoins(coins + (target.type === 'tank' ? 3 : 1));
                        }
                        tower.gatlingAmmo--;
                        tower.gatlingFireDelay = GATLING_FIRE_DELAY;
                        if (tower.gatlingAmmo === 0) {
                            tower.gatlingReload = GATLING_RELOAD_TIME;
                        }
                    }
                }
                if (tower.gatlingFireDelay > 0) tower.gatlingFireDelay--;
            } else if (tower.type === 'archer' || tower.type === 'mage') {
                // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã –æ–±—ã—á–Ω—ã—Ö –±–∞—à–µ–Ω
                let inRange = enemies.filter(e => e.alive && Math.hypot(e.x-tower.x, e.y-tower.y) < TOWER_RADIUS[tower.type] && e.hp > 0);
                if (inRange.length && tower.cooldown<=0 && !gameOver) {
                    if (tower.type==='archer') {
                        // –ü–æ –æ–¥–Ω–æ–º—É –≤—Ä–∞–≥—É
                        shootArrow(tower, inRange[0]);
                        inRange[0].hp -= TOWER_DAMAGE.archer;
                        if (inRange[0].hp <= 0) {
                            inRange[0].alive = false;
                            setCoins(coins + (inRange[0].type === 'tank' ? 3 : 1));
                        }
                    } else {
                        // –ü–æ —Ü–µ–ø–æ—á–∫–µ –¥–æ 3 –≤—Ä–∞–≥–æ–≤
                        let chain = inRange.slice(0, TOWER_CHAIN.mage);
                        chain.forEach(e=>{
                            shootLightning(tower, e);
                            e.hp -= TOWER_DAMAGE.mage;
                            if (e.hp <= 0) {
                                e.alive = false;
                                setCoins(coins + (e.type === 'tank' ? 3 : 1));
                            }
                        });
                    }
                    tower.cooldown = 60; // –∑–∞–¥–µ—Ä–∂–∫–∞ –º–µ–∂–¥—É –≤—ã—Å—Ç—Ä–µ–ª–∞–º–∏
                }
            }
        });
        // –ê–Ω–∏–º–∞—Ü–∏—è –ø—É–ª—å –ø—É–ª–µ–º—ë—Ç–∞
        towers.forEach(tower => {
            if (tower.type === 'gatling' && tower.gatlingBullets) {
                tower.gatlingBullets.forEach(bullet => {
                    if (!bullet.target.alive) bullet.progress = 1;
                    bullet.progress += 0.12;
                    let tx = bullet.target.x, ty = bullet.target.y;
                    bullet.x += (tx - bullet.x) * bullet.progress;
                    bullet.y += (ty - bullet.y) * bullet.progress;
                    ctx.save();
                    ctx.beginPath();
                    ctx.arc(bullet.x, bullet.y, 4, 0, 2*Math.PI);
                    ctx.fillStyle = '#38bdf8';
                    ctx.shadowColor = '#0ea5e9';
                    ctx.shadowBlur = 8;
                    ctx.fill();
                    ctx.shadowBlur = 0;
                    ctx.restore();
                });
                // –£–¥–∞–ª—è–µ–º –¥–æ–ª–µ—Ç–µ–≤—à–∏–µ
                tower.gatlingBullets = tower.gatlingBullets.filter(bullet => bullet.progress < 1);
            }
        });
        // –£–¥–∞–ª—è–µ–º —É–±–∏—Ç—ã—Ö –≤—Ä–∞–≥–æ–≤
        enemies = enemies.filter(e=>e.alive);
        // –ï—Å–ª–∏ –≤—Å–µ –≤—Ä–∞–≥–∏ —É–Ω–∏—á—Ç–æ–∂–µ–Ω—ã –∏ –≤–æ–ª–Ω–∞ –±—ã–ª–∞ –≤ –ø—Ä–æ—Ü–µ—Å—Å–µ ‚Äî —Å–±—Ä–∞—Å—ã–≤–∞–µ–º waveInProgress
        if (waveInProgress && enemies.length === 0 && !gameOver) {
            waveInProgress = false;
            // –ê–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–ª–Ω—ã
            const waveBtn = document.getElementById('wave-btn');
            waveBtn.disabled = false;
            waveBtn.style.opacity = '1';
        }
        if (!gameOver) requestAnimationFrame(gameLoop);
    }
    function endGame() {
        if (gameOver) return;
        if (gameWindow.style.display !== 'flex') return;
        gameOver = true;
        waveInProgress = false;
        document.getElementById('wave-ui').style.display = 'none';
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É–∑—ã–∫—É –∏–≥—Ä—ã –∏ –ø—Ä–æ–∏–≥—Ä—ã–≤–∞–µ–º –≥—Ä—É—Å—Ç–Ω—ã–π –∑–≤—É–∫
        if (window.audioManager) {
            audioManager.stopBackgroundMusic();
            audioManager.playGameOver();
        }
        // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º defeat-actions
        const defeatActions = document.getElementById('defeat-actions');
        defeatActions.innerHTML = `
            <button id="defeat-restart" style="background:#6366f1;color:#fff;font-size:1.2rem;font-weight:700;padding:12px 32px;border:none;border-radius:12px;cursor:pointer;">–ò–≥—Ä–∞—Ç—å —Å–Ω–æ–≤–∞</button>
            <button id="defeat-menu" style="background:#334155;color:#fff;font-size:1.2rem;font-weight:700;padding:12px 32px;border:none;border-radius:12px;cursor:pointer;">–í –º–µ–Ω—é</button>
        `;
        defeatActions.style.display = 'flex';
        document.getElementById('defeat-restart').onclick = () => {
            defeatActions.style.display = 'none';
            resetGame();
            // –ó–∞–ø—É—Å–∫–∞–µ–º –≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –º—É–∑—ã–∫—É –ø—Ä–∏ –ø–æ–≤—Ç–æ—Ä–Ω–æ–π –∏–≥—Ä–µ
            startBattleMusic();
            gameLoop();
        };
        document.getElementById('defeat-menu').onclick = () => {
            defeatActions.style.display = 'none';
            gameWindow.style.display = 'none';
            mainMenu.style.display = 'flex';
            document.getElementById('coins-ui').style.display = 'none';
            document.getElementById('wave-ui').style.display = 'none';
        };
    }
    // --- –§—É–Ω–∫—Ü–∏—è –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –º–æ–Ω–µ—Ç ---
    function setCoins(val) {
        coins = val;
        document.getElementById('coins-count').textContent = coins;
    }
    // --- –ê–Ω–∏–º–∞—Ü–∏—è —Å—Ç—Ä–µ–ª—ã –∏ –º–æ–ª–Ω–∏–∏ ---
    function shootArrow(tower, enemy) {
        ctx.save();
        ctx.strokeStyle = '#fff';
        ctx.lineWidth = 4;
        ctx.beginPath();
        ctx.moveTo(tower.x, tower.y-10);
        ctx.lineTo(enemy.x, enemy.y);
        ctx.stroke();
        ctx.restore();
    }
    function shootLightning(tower, enemy) {
        ctx.save();
        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 3;
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.moveTo(tower.x, tower.y-10);
        ctx.lineTo(enemy.x, enemy.y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.restore();
    }
    function shootGatling(tower, enemy) {
        ctx.save();
        ctx.strokeStyle = '#fbbf24';
        ctx.lineWidth = 3;
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.moveTo(tower.x, tower.y-10);
        ctx.lineTo(enemy.x, enemy.y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.restore();
    }
    // --- –ú—É–∑—ã–∫–∞ –º–µ–Ω—é –±–∞—à–µ–Ω–Ω–æ–π –∑–∞—â–∏—Ç—ã ---
    const menuMusicBtn = document.getElementById('menuMusicBtn');
    let menuMusicWasPlaying = false;

    // –ì—Ä–∞—Ü–∏–æ–∑–Ω–∞—è –º–µ–ª–æ–¥–∏—è –¥–ª—è –º–µ–Ω—é –±–∞—à–µ–Ω–Ω–æ–π –∑–∞—â–∏—Ç—ã
    function startTowerMenuMusic() {
        if (!window.audioManager) window.audioManager = new AudioManager();
        audioManager.stopBackgroundMusic();
        // –ì—Ä–∞—Ü–∏–æ–∑–Ω–∞—è –º–µ–ª–æ–¥–∏—è (–ø—Ä–∏–º–µ—Ä: –ø–ª–∞–≤–Ω–∞—è –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å–Ω–æ—Å—Ç—å)
        const melody = [
            { freq: 392, duration: 0.4 }, // G4
            { freq: 523, duration: 0.4 }, // C5
            { freq: 659, duration: 0.4 }, // E5
            { freq: 784, duration: 0.8 }, // G5
            { freq: 659, duration: 0.4 }, // E5
            { freq: 523, duration: 0.4 }, // C5
            { freq: 392, duration: 0.8 }, // G4
            { freq: 523, duration: 0.4 }, // C5
            { freq: 659, duration: 0.4 }, // E5
            { freq: 784, duration: 0.8 }, // G5
            { freq: 880, duration: 0.4 }, // A5
            { freq: 784, duration: 0.8 }  // G5
        ];
        let noteIdx = 0;
        audioManager.musicInterval = setInterval(() => {
            if (noteIdx >= melody.length) noteIdx = 0;
            const note = melody[noteIdx];
            audioManager.createMusicTone(note.freq, note.duration, 'triangle');
            noteIdx++;
        }, 400);
    }
    function stopTowerMenuMusic() {
        if (window.audioManager) audioManager.stopBackgroundMusic();
    }
    menuMusicBtn.addEventListener('click', () => {
        if (!window.audioManager) window.audioManager = new AudioManager();
        if (audioManager.musicInterval) {
            stopTowerMenuMusic();
            menuMusicWasPlaying = false;
            menuMusicBtn.textContent = 'üîá';
        } else {
            startTowerMenuMusic();
            menuMusicWasPlaying = true;
            menuMusicBtn.textContent = 'üéµ';
        }
    });
    // –ü—Ä–∏ –æ—Ç–∫—Ä—ã—Ç–∏–∏ –º–µ–Ω—é ‚Äî –≤–æ—Å—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–µ
    function updateMenuMusicButton() {
        if (window.audioManager && audioManager.musicInterval) {
            menuMusicBtn.textContent = 'üéµ';
        } else {
            menuMusicBtn.textContent = 'üîá';
        }
    }
    if (typeof mainMenu !== 'undefined') {
        mainMenu.addEventListener('show', () => {
            updateMenuMusicButton();
        });
    }
    updateMenuMusicButton();
    // --- –ú—É–∑—ã–∫–∞ –¥–ª—è —Å–∞–º–æ–π –∏–≥—Ä—ã (–≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω–∞—è –∏ —Å—É—Ä–æ–≤–∞—è) ---
    function startBattleMusic() {
        if (!window.audioManager) window.audioManager = new AudioManager();
        audioManager.stopBackgroundMusic();
        // –ù–æ–≤—ã–π —Å—É—Ä–æ–≤—ã–π –º–æ—Ç–∏–≤ –¥–ª—è –∏–≥—Ä—ã
        const melody = [
            { freq: 220, duration: 0.35 }, // A3
            { freq: 277, duration: 0.25 }, // C#4
            { freq: 349, duration: 0.35 }, // F4
            { freq: 415, duration: 0.25 }, // G#4
            { freq: 392, duration: 0.25 }, // G4
            { freq: 349, duration: 0.25 }, // F4
            { freq: 293, duration: 0.35 }, // D4
            { freq: 220, duration: 0.5 },  // A3
            { freq: 293, duration: 0.25 }, // D4
            { freq: 349, duration: 0.25 }, // F4
            { freq: 392, duration: 0.35 }, // G4
            { freq: 440, duration: 0.25 }, // A4
            { freq: 415, duration: 0.25 }, // G#4
            { freq: 349, duration: 0.35 }, // F4
            { freq: 293, duration: 0.25 }, // D4
            { freq: 220, duration: 0.5 }   // A3
        ];
        let noteIdx = 0;
        audioManager.musicInterval = setInterval(() => {
            if (noteIdx >= melody.length) noteIdx = 0;
            const note = melody[noteIdx];
            audioManager.createMusicTone(note.freq, note.duration, noteIdx % 4 === 0 ? 'sawtooth' : 'square');
            noteIdx++;
        }, 320);
    }
    // --- –ó–∞–ø—É—Å–∫ —Ç–µ—Å—Ç–∞ ---
    playBtn.onclick = () => {
        mainMenu.style.display = 'none';
        gameWindow.style.display = 'flex';
        document.getElementById('coins-ui').style.display = 'flex';
        document.getElementById('wave-ui').style.display = 'flex';
        document.getElementById('defeat-actions').style.display = 'none';
        resetGame();
        // –û—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –º—É–∑—ã–∫—É –º–µ–Ω—é –∏ –∑–∞–ø—É—Å–∫–∞–µ–º –≤–æ–∏–Ω—Å—Ç–≤–µ–Ω–Ω—É—é –º—É–∑—ã–∫—É
        stopTowerMenuMusic();
        startBattleMusic();
        // –°—Ä–∞–∑—É –∞–∫—Ç–∏–≤–∏—Ä—É–µ–º –∫–Ω–æ–ø–∫—É –≤–æ–ª–Ω—ã
        const waveBtn = document.getElementById('wave-btn');
        waveBtn.disabled = false;
        waveBtn.style.opacity = '1';
        gameLoop();
    };
    const waveBtn = document.getElementById('wave-btn');
    waveBtn.onclick = () => {
        if (waveInProgress) return; // –ë–ª–æ–∫–∏—Ä—É–µ–º –Ω–∞–∂–∞—Ç–∏–µ –≤–æ –≤—Ä–µ–º—è –≤–æ–ª–Ω—ã
        wave++;
        document.getElementById('wave-num').textContent = wave;
        if (typeof window.waveEnemyCount === 'undefined') {
            window.waveEnemyCount = 10;
        } else {
            let add = Math.floor(Math.random()*5)+1;
            window.waveEnemyCount = window.waveEnemyCount + add;
        }
        spawnWave(window.waveEnemyCount);
        // –î–µ–ª–∞–µ–º –∫–Ω–æ–ø–∫—É –Ω–µ–∞–∫—Ç–∏–≤–Ω–æ–π
        waveBtn.disabled = true;
        waveBtn.style.opacity = '0.5';
    };
    </script>
</body>
</html> 